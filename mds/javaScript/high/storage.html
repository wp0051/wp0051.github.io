<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>内存管理 | 前端笔记</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-C5QREZ3P.css" as="style"><link rel="stylesheet" href="/assets/style-C5QREZ3P.css">
    <link rel="modulepreload" href="/assets/app-D6TqyvMs.js"><link rel="modulepreload" href="/assets/storage.html-BUzDIVEU.js">
    <link rel="prefetch" href="/assets/index.html-BcZd1lvp.js" as="script"><link rel="prefetch" href="/assets/flutter.html-B09vP2oB.js" as="script"><link rel="prefetch" href="/assets/javascript.html-TUHoYsiS.js" as="script"><link rel="prefetch" href="/assets/loginNginx.html-BVywJNyX.js" as="script"><link rel="prefetch" href="/assets/mysql.html-Bcf30ZtN.js" as="script"><link rel="prefetch" href="/assets/nginx.html-128XVq0x.js" as="script"><link rel="prefetch" href="/assets/react.html-BaDBqkrW.js" as="script"><link rel="prefetch" href="/assets/server.html-JgIvPMXH.js" as="script"><link rel="prefetch" href="/assets/gulp.html-J5QChLu9.js" as="script"><link rel="prefetch" href="/assets/npm.html-W-5yHm1N.js" as="script"><link rel="prefetch" href="/assets/vite.html-CrSzeqR3.js" as="script"><link rel="prefetch" href="/assets/webpack-dev-conf.html-Dv_5GTMz.js" as="script"><link rel="prefetch" href="/assets/webpack.html-HRDcK3bw.js" as="script"><link rel="prefetch" href="/assets/brew.html-DSIa35tp.js" as="script"><link rel="prefetch" href="/assets/git.html-BoZqCUHu.js" as="script"><link rel="prefetch" href="/assets/node.html-ChlNFiPz.js" as="script"><link rel="prefetch" href="/assets/nvm.html-DVvFK9OD.js" as="script"><link rel="prefetch" href="/assets/basejieshao.html-Sd0zluD0.js" as="script"><link rel="prefetch" href="/assets/sass.html-9nidoaOD.js" as="script"><link rel="prefetch" href="/assets/vue2.html-CZeVJ9to.js" as="script"><link rel="prefetch" href="/assets/vue2_project.html-DlwYTE0m.js" as="script"><link rel="prefetch" href="/assets/vue2_router.html-RpKMJYMA.js" as="script"><link rel="prefetch" href="/assets/vue2_vuex.html-CSDFLmPe.js" as="script"><link rel="prefetch" href="/assets/vue3.html-CreKIZcH.js" as="script"><link rel="prefetch" href="/assets/AjaxXML.html-ciq0smEM.js" as="script"><link rel="prefetch" href="/assets/asyncawait.html-DtIKP4cH.js" as="script"><link rel="prefetch" href="/assets/crossOrigin.html-1CO4zoNR.js" as="script"><link rel="prefetch" href="/assets/fetch.html-BB4-L1_B.js" as="script"><link rel="prefetch" href="/assets/Generator.html-B_mSiFAj.js" as="script"><link rel="prefetch" href="/assets/packageUpload.html-CGLHFj7u.js" as="script"><link rel="prefetch" href="/assets/Promise.html-vT4nvGPv.js" as="script"><link rel="prefetch" href="/assets/console.html-COTArx2o.js" as="script"><link rel="prefetch" href="/assets/history.html-CLHu8jhg.js" as="script"><link rel="prefetch" href="/assets/location.html-BmGQvwlF.js" as="script"><link rel="prefetch" href="/assets/Navigator.html-WKLP-8hA.js" as="script"><link rel="prefetch" href="/assets/window.html-Bjab9cuA.js" as="script"><link rel="prefetch" href="/assets/anime.html-YJkHvvsW.js" as="script"><link rel="prefetch" href="/assets/baseEvent.html-Bz9gU_DG.js" as="script"><link rel="prefetch" href="/assets/DOM.html-FKuCeGoG.js" as="script"><link rel="prefetch" href="/assets/DOMNode.html-CoHXAfqB.js" as="script"><link rel="prefetch" href="/assets/domPosition.html-CIeCS6mB.js" as="script"><link rel="prefetch" href="/assets/highEvent.html-BgHmp-lK.js" as="script"><link rel="prefetch" href="/assets/localStroge.html-DrzPkZX1.js" as="script"><link rel="prefetch" href="/assets/operaForm.html-DFszINbo.js" as="script"><link rel="prefetch" href="/assets/phoneEvent.html-BfzXsjQY.js" as="script"><link rel="prefetch" href="/assets/arr.html-CBjcjnYT.js" as="script"><link rel="prefetch" href="/assets/debugError.html-D5CWrULl.js" as="script"><link rel="prefetch" href="/assets/Map.html-Do1VFh8c.js" as="script"><link rel="prefetch" href="/assets/phoneDebug.html-Krq9UfI1.js" as="script"><link rel="prefetch" href="/assets/processControl.html-C1pPHcSI.js" as="script"><link rel="prefetch" href="/assets/Set.html-9lVsKrK8.js" as="script"><link rel="prefetch" href="/assets/Symbol.html-qPIExdtd.js" as="script"><link rel="prefetch" href="/assets/transferDataType.html-CtTNwgYw.js" as="script"><link rel="prefetch" href="/assets/var_dateType.html-UFd2wzME.js" as="script"><link rel="prefetch" href="/assets/yunsuanfu.html-Br7YWDRC.js" as="script"><link rel="prefetch" href="/assets/collect.html-C5Zl-xaE.js" as="script"><link rel="prefetch" href="/assets/designMode.html-D-EMGqrC.js" as="script"><link rel="prefetch" href="/assets/moduleDev.html-DhrnizZB.js" as="script"><link rel="prefetch" href="/assets/strict.html-B_kNxRav.js" as="script"><link rel="prefetch" href="/assets/suanfa.html-D94EeJ8C.js" as="script"><link rel="prefetch" href="/assets/webSocket.html-Cx_oZ9q5.js" as="script"><link rel="prefetch" href="/assets/argument_return.html-CpkrXZJE.js" as="script"><link rel="prefetch" href="/assets/highfunc.html-C5Wx-LTa.js" as="script"><link rel="prefetch" href="/assets/varfunc.html-DVQZm8d4.js" as="script"><link rel="prefetch" href="/assets/zuoyongyu.html-ejqbcARi.js" as="script"><link rel="prefetch" href="/assets/Array.html-XEWGRbf0.js" as="script"><link rel="prefetch" href="/assets/Class.html-HqTY595E.js" as="script"><link rel="prefetch" href="/assets/Date.html-yHlGSorm.js" as="script"><link rel="prefetch" href="/assets/faceObjectCode.html-Dz_K20C2.js" as="script"><link rel="prefetch" href="/assets/Math.html-DkgXhtE1.js" as="script"><link rel="prefetch" href="/assets/Object.html-tVF0SArq.js" as="script"><link rel="prefetch" href="/assets/objectbase.html-CKx0EibA.js" as="script"><link rel="prefetch" href="/assets/objectSpecial.html-C-7sOL91.js" as="script"><link rel="prefetch" href="/assets/reg.html-CyGCCaWA.js" as="script"><link rel="prefetch" href="/assets/String.html-XwryKtpd.js" as="script"><link rel="prefetch" href="/assets/404.html-Bx9sDhMU.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">前端笔记</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">内存管理 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="内存管理" tabindex="-1"><a class="header-anchor" href="#内存管理"><span>内存管理</span></a></h1><h2 id="内存生命周期" tabindex="-1"><a class="header-anchor" href="#内存生命周期"><span>内存生命周期</span></a></h2><p>不管什么程序语言，内存生命周期基本是一致的：</p><ol><li>分配你所需要的内存</li><li>使用分配到的内存（读、写）</li><li>不需要时将其释放、归还</li></ol><p>所有语言第二部分都是明确的。第一和第三部分在底层语言中是明确的，但在像JavaScript这些高级语言中，大部分都是隐含的。</p><p>js的内存生命周期：</p><ol><li>定义变量时就完成了内存分配</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">// 给数值变量分配内存</span></span>
<span class="line"><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">&quot;azerty&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 给字符串分配内存</span></span>
<span class="line"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 给对象及其包含的值分配内存</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token comment">// 给函数（可调用的对象）分配内存</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用值的过程实际上是对分配内存进行读取与写入的操作。读取与写入可能是写入一个变量或者一个对象的属性值，甚至传递函数的参数。</li><li>而内存的释放而依赖GC机制（高级语言解释器嵌入的“垃圾回收器”）。</li></ol><h2 id="垃圾回收" tabindex="-1"><a class="header-anchor" href="#垃圾回收"><span>垃圾回收</span></a></h2><h3 id="引用" tabindex="-1"><a class="header-anchor" href="#引用"><span>引用</span></a></h3><p>垃圾回收算法主要依赖于引用的概念。在内存管理的环境中，一个对象如果有访问另一个对象的权限（隐式或者显式），叫做一个对象引用另一个对象。例如，一个Javascript对象具有对它原型的引用（隐式引用）和对它属性的引用（显式引用）。</p><h4 id="引用计数垃圾收集-计数算法" tabindex="-1"><a class="header-anchor" href="#引用计数垃圾收集-计数算法"><span>引用计数垃圾收集(计数算法)</span></a></h4><p>把“对象是否不再需要”简化定义为“对象有没有其他对象引用到它”。如果没有引用指向该对象（零引用），对象将被垃圾回收机制回收。<br> 无法处理循环引用</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 创建一个对象person，他有两个指向属性age和name的引用</span></span>
<span class="line"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;aaaa&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">// 虽然设置为null，但因为person对象还有指向name的引用，因此name不会回收</span></span>
<span class="line"><span class="token keyword">var</span> p <span class="token operator">=</span> person<span class="token punctuation">;</span></span>
<span class="line">person <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">//原来的person对象被赋值为1，但因为有新引用p指向原person对象，因此它不会被回收</span></span>
<span class="line">p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">//原person对象已经没有引用，很快会被回收</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="循环引用-上面垃圾回收的限制" tabindex="-1"><a class="header-anchor" href="#循环引用-上面垃圾回收的限制"><span>循环引用(上面垃圾回收的限制)</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  obj<span class="token punctuation">.</span>a <span class="token operator">=</span> obj2<span class="token punctuation">;</span> <span class="token comment">// obj 引用 obj2</span></span>
<span class="line">  obj2<span class="token punctuation">.</span>a <span class="token operator">=</span> obj<span class="token punctuation">;</span> <span class="token comment">// obj2 引用 obj</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token string">&quot;azerty&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>两个对象被创建，并互相引用，形成了一个循环。它们被调用之后会离开函数作用域，所以它们已经没有用了，可以被回收了。然而，引用计数算法考虑到它们互相都有至少一次引用，所以它们不会被回收。</p><h4 id="标记-清除算法" tabindex="-1"><a class="header-anchor" href="#标记-清除算法"><span>标记-清除算法</span></a></h4><p>现代的浏览器已经不再使用引用计数算法了。现代浏览器通用的大多是基于标记清除算法的某些改进算法，总体思想都是一致的。</p><p>标记清除算法将“不再使用的对象”定义为“无法达到的对象”。简单来说，就是从根部（在JS中就是全局对象）出发定时扫描内存中的对象。凡是能从根部到达的对象，都是还需要使用的。那些无法由根部出发触及到的对象被标记为不再使用，稍后进行回收。</p><h3 id="内存泄漏" tabindex="-1"><a class="header-anchor" href="#内存泄漏"><span>内存泄漏</span></a></h3><p>对于持续运行的服务进程，必须及时释放不再用到的内存。否则，内存占用越来越高，轻则影响系统性能，重则导致进程崩溃。不再用到的内存，没有及时释放，就叫做内存泄漏。</p><h4 id="内存泄漏的识别方法" tabindex="-1"><a class="header-anchor" href="#内存泄漏的识别方法"><span>内存泄漏的识别方法</span></a></h4><p>如果连续五次垃圾回收之后，内存占用一次比一次大，就有内存泄漏。</p><ol><li>浏览器方法 <ol><li>打开开发者工具，</li><li>在顶部的Capture字段里面勾选 Memory 选择 Timeline 面板</li><li>点击左上角的录制按钮。</li><li>在页面上进行各种操作，模拟用户的使用情况。</li><li>一段时间后，点击对话框的 stop 按钮，面板上就会显示这段时间的内存占用情况。</li></ol></li></ol><p>如果内存占用基本平稳，接近水平，就说明不存在内存泄漏。 反之，就是内存泄漏了。</p><ol start="2"><li>命令行方法 命令行可以使用 Node 提供的 <code>process.memoryUsage</code> 方法。</li></ol><p>process.memoryUsage返回一个对象，包含了 Node 进程的内存占用信息。该对象包含四个字段，单位是字节，</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//  rss:        所有内存占用，包括指令区和堆栈。</span></span>
<span class="line"><span class="token comment">//  heapTotal:     &quot;堆&quot;占用的内存，包括用到的和没用到的。</span></span>
<span class="line"><span class="token comment">//  heapUsed:    用到的堆的部分。</span></span>
<span class="line"><span class="token comment">//  external:     V8 引擎内部的 C++ 对象占用的内存。</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 判断内存泄漏，以heapUsed字段为准。</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="常见内存泄漏" tabindex="-1"><a class="header-anchor" href="#常见内存泄漏"><span>常见内存泄漏</span></a></h3><p>如果还需要兼容老旧浏览器，那么就需要注意代码中的循环引用问题。或者直接采用保证兼容性的库来帮助优化代码。</p><p>对现代浏览器来说，唯一要注意的就是明确切断需要回收的对象与根部的联系。有时候这种联系并不明显，且因为标记清除算法的强壮性，这个问题较少出现。最常见的内存泄露一般都与DOM元素绑定有关。</p><ol><li>绝对不要定义全局变量<br> JavaScript用一个有趣的方式管理未被声明的变量：对未声明的变量的引用在全局对象里创建一个新的变量。在浏览器的情况下，这个全局对象是 window 。为了防止这种意外，可以使用严格模式来阻止</li><li>手工解除变量引用<br> 一个变量已经确切是不再需要了，那么就可以手工解除变量引用，以使其被回收。</li><li>闭包</li><li>DOM外引用</li></ol></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-D6TqyvMs.js" defer></script>
  </body>
</html>
