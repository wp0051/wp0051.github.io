<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>node build/dev-server.js | 前端笔记</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-C5QREZ3P.css" as="style"><link rel="stylesheet" href="/assets/style-C5QREZ3P.css">
    <link rel="modulepreload" href="/assets/app-34Y0emjC.js"><link rel="modulepreload" href="/assets/webpack.html-1iyKbErE.js">
    <link rel="prefetch" href="/assets/index.html-UaGxkCy4.js" as="script"><link rel="prefetch" href="/assets/flutter.html-DBHjzBLe.js" as="script"><link rel="prefetch" href="/assets/javascript.html-DtPrlpBO.js" as="script"><link rel="prefetch" href="/assets/loginNginx.html-BQ_QAgiu.js" as="script"><link rel="prefetch" href="/assets/mysql.html-DLJBs6ND.js" as="script"><link rel="prefetch" href="/assets/nginx.html-Bf4Szspc.js" as="script"><link rel="prefetch" href="/assets/node.html-BtGyUcc_.js" as="script"><link rel="prefetch" href="/assets/react.html-CZUjMelg.js" as="script"><link rel="prefetch" href="/assets/server.html-CKSiTZ-i.js" as="script"><link rel="prefetch" href="/assets/gulp.html-BeGu4zSE.js" as="script"><link rel="prefetch" href="/assets/npm.html-Cs6kthBG.js" as="script"><link rel="prefetch" href="/assets/vite.html-BP03Ysy1.js" as="script"><link rel="prefetch" href="/assets/webpack-dev-conf.html-DkES_XNc.js" as="script"><link rel="prefetch" href="/assets/brew.html-Whlmy9Ct.js" as="script"><link rel="prefetch" href="/assets/git.html-s6fegLLk.js" as="script"><link rel="prefetch" href="/assets/node.html-B06GqquJ.js" as="script"><link rel="prefetch" href="/assets/nvm.html-9dwZSSgT.js" as="script"><link rel="prefetch" href="/assets/basejieshao.html-CnLq_SEo.js" as="script"><link rel="prefetch" href="/assets/sass.html-ByITuZ16.js" as="script"><link rel="prefetch" href="/assets/vue2.html-P2Z87HNR.js" as="script"><link rel="prefetch" href="/assets/vue2_project.html-CRo1M2rS.js" as="script"><link rel="prefetch" href="/assets/vue2_router.html-IE7zeUuf.js" as="script"><link rel="prefetch" href="/assets/vue2_vuex.html-CrigqrFO.js" as="script"><link rel="prefetch" href="/assets/vue3.html-CJJg9a7V.js" as="script"><link rel="prefetch" href="/assets/vue3_pinia.html-D92qVnmj.js" as="script"><link rel="prefetch" href="/assets/vue3_router.html-Bf9ce-8J.js" as="script"><link rel="prefetch" href="/assets/AjaxXML.html-QWCpUQbT.js" as="script"><link rel="prefetch" href="/assets/asyncawait.html-VbfBEwLi.js" as="script"><link rel="prefetch" href="/assets/crossOrigin.html-DnBaXCIJ.js" as="script"><link rel="prefetch" href="/assets/fetch.html-BCtLZJ5f.js" as="script"><link rel="prefetch" href="/assets/Generator.html-CC9DHNxy.js" as="script"><link rel="prefetch" href="/assets/packageUpload.html-hINW47kr.js" as="script"><link rel="prefetch" href="/assets/Promise.html-CDKHFcvi.js" as="script"><link rel="prefetch" href="/assets/console.html-DVuZPWdS.js" as="script"><link rel="prefetch" href="/assets/history.html-g5OvMs_7.js" as="script"><link rel="prefetch" href="/assets/location.html-DSAis5c1.js" as="script"><link rel="prefetch" href="/assets/Navigator.html-Bl6r7gJw.js" as="script"><link rel="prefetch" href="/assets/window.html-B-Gw3LLq.js" as="script"><link rel="prefetch" href="/assets/anime.html-BXPhqQoi.js" as="script"><link rel="prefetch" href="/assets/baseEvent.html-BusDqyLd.js" as="script"><link rel="prefetch" href="/assets/DOM.html-3i_T_Rec.js" as="script"><link rel="prefetch" href="/assets/DOMNode.html-D1Pjun9h.js" as="script"><link rel="prefetch" href="/assets/domPosition.html-B8BIv8ew.js" as="script"><link rel="prefetch" href="/assets/highEvent.html-CTPlm-Ci.js" as="script"><link rel="prefetch" href="/assets/localStroge.html-BNFD7dtg.js" as="script"><link rel="prefetch" href="/assets/operaForm.html-BakD0dGg.js" as="script"><link rel="prefetch" href="/assets/phoneEvent.html-DAk99yvh.js" as="script"><link rel="prefetch" href="/assets/arr.html-BXe2_7Rw.js" as="script"><link rel="prefetch" href="/assets/debugError.html-n7qwBWBi.js" as="script"><link rel="prefetch" href="/assets/Map.html-DujIRI_x.js" as="script"><link rel="prefetch" href="/assets/phoneDebug.html-Cvdey6_G.js" as="script"><link rel="prefetch" href="/assets/processControl.html-CILWQjWl.js" as="script"><link rel="prefetch" href="/assets/Set.html-DM4g1Rs4.js" as="script"><link rel="prefetch" href="/assets/Symbol.html-DN1ywOfh.js" as="script"><link rel="prefetch" href="/assets/transferDataType.html-CMcyweP2.js" as="script"><link rel="prefetch" href="/assets/var_dateType.html-CKcyQWb9.js" as="script"><link rel="prefetch" href="/assets/yunsuanfu.html-m4hcOWGx.js" as="script"><link rel="prefetch" href="/assets/collect.html-DhBRhnpm.js" as="script"><link rel="prefetch" href="/assets/designMode.html-hHNbQqih.js" as="script"><link rel="prefetch" href="/assets/moduleDev.html-SyEWkbip.js" as="script"><link rel="prefetch" href="/assets/storage.html-DJ7S1tg3.js" as="script"><link rel="prefetch" href="/assets/strict.html-CMjYNo8b.js" as="script"><link rel="prefetch" href="/assets/suanfa.html-DbmHYGEq.js" as="script"><link rel="prefetch" href="/assets/webSocket.html-C1knZfJl.js" as="script"><link rel="prefetch" href="/assets/argument_return.html-Cols24q2.js" as="script"><link rel="prefetch" href="/assets/highfunc.html-CJKtZjlo.js" as="script"><link rel="prefetch" href="/assets/varfunc.html-DRQJyc0_.js" as="script"><link rel="prefetch" href="/assets/zuoyongyu.html-BAhTivP8.js" as="script"><link rel="prefetch" href="/assets/Array.html-DXH6Sg-e.js" as="script"><link rel="prefetch" href="/assets/Class.html-DYF2ELEM.js" as="script"><link rel="prefetch" href="/assets/Date.html-e33QwLCC.js" as="script"><link rel="prefetch" href="/assets/faceObjectCode.html-XH4_gkKg.js" as="script"><link rel="prefetch" href="/assets/Math.html-Gd6eyw66.js" as="script"><link rel="prefetch" href="/assets/Object.html-CPG5z0dn.js" as="script"><link rel="prefetch" href="/assets/objectbase.html-zQ9cFlqe.js" as="script"><link rel="prefetch" href="/assets/objectSpecial.html-2ivlXHua.js" as="script"><link rel="prefetch" href="/assets/reg.html-U4a5TWvn.js" as="script"><link rel="prefetch" href="/assets/String.html-CIWD1gWZ.js" as="script"><link rel="prefetch" href="/assets/404.html-lCt3-m2m.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">前端笔记</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">node build/dev-server.js <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="node-build-dev-server-js" tabindex="-1"><a class="header-anchor" href="#node-build-dev-server-js"><span>node build/dev-server.js</span></a></h1><h2 id="检查各执行脚本的版本" tabindex="-1"><a class="header-anchor" href="#检查各执行脚本的版本"><span>检查各执行脚本的版本</span></a></h2><ul><li>检查当前环境下各个脚本版本是否符合package.json下执行的版本规则</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./check-versions&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// check-versions</span></span>
<span class="line"><span class="token keyword">var</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span>   <span class="token comment">// 终端输出颜色化</span></span>
<span class="line"><span class="token keyword">var</span> semver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;semver&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 语义化版本号处理</span></span>
<span class="line"><span class="token keyword">var</span> packageConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../package.json&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">exec</span> <span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;child_process&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 创建一个子进程，同步执行传入的命令（cmd），转化字符串，去除空格</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> versionRequirements <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;node&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">currentVersion</span><span class="token operator">:</span> semver<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// clean方法不是清空，是将获取到的node版本号 v11.15.0语义化11.15.0</span></span>
<span class="line">    <span class="token literal-property property">versionRequirement</span><span class="token operator">:</span> packageConfig<span class="token punctuation">.</span>engines<span class="token punctuation">.</span>node  <span class="token comment">// 从package.json读取node的版本要求(engines.node)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;npm&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">currentVersion</span><span class="token operator">:</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&#39;npm --version&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 输出直接就是6.7.0</span></span>
<span class="line">    <span class="token literal-property property">versionRequirement</span><span class="token operator">:</span> packageConfig<span class="token punctuation">.</span>engines<span class="token punctuation">.</span>npm</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> warnings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> versionRequirements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> mod <span class="token operator">=</span> versionRequirements<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">    <span class="token comment">// 使用 semver.satisfies 检查版本是否满足要求</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>currentVersion<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>versionRequirement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 如果当前进程的node/npm不符合package.json的要求，添加警告</span></span>
<span class="line">      warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&#39;: &#39;</span> <span class="token operator">+</span></span>
<span class="line">        chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>currentVersion<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39; should be &#39;</span> <span class="token operator">+</span>  </span>
<span class="line">        chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>versionRequirement<span class="token punctuation">)</span>  <span class="token comment">// 美化终端输出 比如这段输出为    node：6.6.6(这个版本号是红色的子) shoule be &gt; 10.8.8(这个版本号是绿色的)</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>warnings<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">&#39;To use this template, you must update following to modules:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> warnings<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">var</span> warning <span class="token operator">=</span> warnings<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;  &#39;</span> <span class="token operator">+</span> warning<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">// 退出进程，返回错误码 1,非0都是错误码，这个就属于错误退出进程，命令终止，不往下执行了，输出错误信息；如果是0，那就是成功的退出码，正常退出，继续执行后面的指令</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取当前环境变量env" tabindex="-1"><a class="header-anchor" href="#获取当前环境变量env"><span>获取当前环境变量ENV</span></a></h2><ul><li>获取当前进程环境变量NODE_ENV的值，没有默认读取dev的环境变量</li><li><em><strong>我最初有执行cross-env NODE_ENV=development，为什么获取不到呢</strong></em><ul><li>因为这段命令之后直接&amp;&amp;连接下一个命令，所以上面这个命令只是做了 <strong>设置环境变量NODE_ENV，然后退出进程，删除环境变量</strong></li><li>命令除了消耗一点CPU时间外，没有任何实际作用。</li><li>正确写法是<strong>cross-env NODE_ENV=development node dev-server.js</strong></li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../config&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>  <span class="token comment">// 当前代码是JSON.parse(config.dev.env.NODE_ENV)这是因为dev里面声明env: &#39;&quot;development&quot;&#39;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取开发环境的webpack配置" tabindex="-1"><a class="header-anchor" href="#获取开发环境的webpack配置"><span>获取开发环境的webpack配置</span></a></h2><ul><li>查看<a class="route-link" href="/mds/buildTools/webpack-dev-conf.html">webpack.dev.conf</a>配置解读</li><li>process.env.PORT可以通过 PORT=6666 npm run dev --account 设置</li><li>autoOpenBrowser 是否自动打开浏览器 !! --&gt; 转换为 Boolean值</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> webpackConfig <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span></span>
<span class="line">  <span class="token operator">?</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.prod.conf&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.dev.conf&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>port<span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">var</span> autoOpenBrowser <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>autoOpenBrowser</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="引入服务器框架express-webpack" tabindex="-1"><a class="header-anchor" href="#引入服务器框架express-webpack"><span>引入服务器框架express，webpack</span></a></h2><h3 id="创建实例" tabindex="-1"><a class="header-anchor" href="#创建实例"><span>创建实例</span></a></h3><ul><li>创建Express服务器实例，初始化一个 Web 服务器，用于处理 HTTP 请求，后续可以添加路由、中间件等。</li><li>创建Webpack实例，但是尚未执行打包，根据webpack.prod.conf或者webpack.dev.conf创建compiler编译器</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="构建启动服务" tabindex="-1"><a class="header-anchor" href="#构建启动服务"><span>构建启动服务</span></a></h3><ul><li>我们实际打包查看发现：执行npm run dev后，webpackConfig.output.publicPath下没有打包文件夹，并且从终端输出来看执行完gulp之后，等了几秒，终端输出&quot;开始打开&quot; + uri，打开默认浏览器打开了&#39;http://localhost:&#39; + port + <code>/${tempUrl}/index.html</code>;页面一直加载也没有失败404，过了一会儿终端输出Compiled successfully in 20975ms 以及Listening at http://localhost:8085/account/index.html, 下面来解释这个过程，并且查看构建和启动服务流程。</li></ul><h4 id="开始构建" tabindex="-1"><a class="header-anchor" href="#开始构建"><span>开始构建</span></a></h4><ul><li>require(&#39;webpack-dev-middleware&#39;)：接收构建器，启动 webpack 的 watch 模式（文件监控和编译），将打包输出存到内存中（没存到硬盘，肉眼看不到）</li><li>这个构建过程是异步操作，所以先执行后面的操作，而浏览器请求一直没失败是因为执行了HTTP请求挂起，不立即响应，挂起请求</li><li>浏览器还无法访问编译结果,HTTP 请求无法被处理, 编译结果&quot;困在&quot;内存中，没有对外接口</li><li>require(&#39;webpack-hot-middleware&#39;)启用热模块替换（HMR），建立 WebSocket 连接，实现浏览器与服务器实时通信，<em><strong>在webpack入口文件依赖的代码变更时</strong></em> 发送给浏览器，但是浏览器这个时候不会更新，还需要依赖热更新插件代码执行模块更新</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> webpackConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>  <span class="token comment">// 设置输出路径</span></span>
<span class="line">  <span class="token literal-property property">quiet</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 减少日志</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> hotMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-hot-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">┌─────────────────┐    ┌──────────────────┐    ┌────────────────┐</span>
<span class="line">│   浏览器         │    │   Express服务器  │    │   内存文件系统  │</span>
<span class="line">│                 │    │                  │    │                │</span>
<span class="line">│ 请求 main.js ───┼─—-─→│ devMiddleware   |───→│ /dist/main.js  │</span>
<span class="line">│                 │    │                  │    │                │</span>
<span class="line">│ 收到JS文件 ←─────┼────│ 返回内存内容 ←────┼────│ 内存中的代码    │</span>
<span class="line">└─────────────────┘    └──────────────────┘    └────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="添加页面重载事件钩子" tabindex="-1"><a class="header-anchor" href="#添加页面重载事件钩子"><span>添加页面重载事件钩子</span></a></h4><ul><li>监听了 webpack 编译器的 &#39;compilation&#39; 事件，该事件在每次创建新的编译时触发</li><li>在编译过程中，又监听了 &#39;html-webpack-plugin-after-emit&#39; 事件，这个事件是由 html-webpack-plugin 在生成 HTML 文件并发出到输出目录后触发的。</li><li>当 html-webpack-plugin 处理的 HTML 模板(在<a class="route-link" href="/mds/buildTools/webpack-dev-conf.html">webpack.dev.conf</a>查看)发生变化时，通过热重载中间件发送一个重载信号，强制页面重新加载（因为热更新可能无法直接更新 HTML 文件， 因为webpack针对的是js入口）</li><li>其实这段代码是有害的，因为有热更新员（webpack-hot-middleware，实现浏览器与服务器实时通信 ）加webpack热加载插件（HotModuleReplacementPlugin），打包插入更新脚本，接收更新员通知的更新，执行更新，而下方代码代码更新，直接重载，破坏了上面的组合</li><li>什么情况需要呢？？场景1：HTML模板结构发生重大变化<code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt; -&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</code>;手动管理缓存的极端情况</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// force page reload when html-webpack-plugin template changes</span></span>
<span class="line">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;compilation&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  compilation<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;html-webpack-plugin-after-emit&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    hotMiddleware<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&#39;reload&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="解决前端路径资源404问题" tabindex="-1"><a class="header-anchor" href="#解决前端路径资源404问题"><span>解决前端路径资源404问题</span></a></h4><ul><li>浏览器请求: http://localhost:8085/user/profile</li><li>服务器检查: 没有 /user/profile 这个文件</li><li>history-api-fallback 介入</li><li>返回: 入口页面</li><li>浏览器收到入口文件，前端路由接管显示 /user/profile 页面</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// handle fallback for HTML5 history API</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;connect-history-api-fallback&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="建立浏览器服务器热更新通信" tabindex="-1"><a class="header-anchor" href="#建立浏览器服务器热更新通信"><span>建立浏览器服务器热更新通信</span></a></h4><ul><li>将内存中的编译结果暴露为 HTTP 服务,处理静态资源请求,建立浏览器与编译结果的桥梁</li><li>建立浏览器与服务器的双向通信通道，让热更新有效</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token comment">// serve webpack bundle output</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>devMiddleware<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// enable hot-reload and state-preserving</span></span>
<span class="line"><span class="token comment">// compilation error display</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>hotMiddleware<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="暴露可访问静态资源目录" tabindex="-1"><a class="header-anchor" href="#暴露可访问静态资源目录"><span>暴露可访问静态资源目录</span></a></h4><ul><li>在入口文件查找下的图片资源会经过打包到webpack的output下，这个资源devMiddleware可以提供访问，但是一些静态资源（如果css未在入口文件为源头查找发现使用，那脱离devMiddleware内存存储的静态资源更多），需要开发静态资源的访问权限（现在开发服务器根路径在output输出文件夹）；</li><li>path.posix.join(): 使用 POSIX 风格的路径拼接（兼容 Unix/Linux 和 Windows）</li><li>然后废弃上面的设置，直接设置为根目录</li><li>express.static(&#39;static&#39;): 创建指向 static 目录的静态文件服务</li><li>app.use(&#39;/&#39;, ...): 将这个服务挂载到根路径</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// serve pure static assets</span></span>
<span class="line"><span class="token keyword">var</span> staticPath <span class="token operator">=</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>assetsPublicPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>assetsSubDirectory<span class="token punctuation">)</span></span>
<span class="line">staticPath <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>staticPath<span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="开启端口监听自定打开浏览器" tabindex="-1"><a class="header-anchor" href="#开启端口监听自定打开浏览器"><span>开启端口监听自定打开浏览器</span></a></h4><ul><li>getCommand获取命令参数，打包模块名</li><li>编译结束之后输出信息</li><li>app.listen 监听指定端口，打开（opn）模块index页面</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> opn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;opn&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> comUrl <span class="token operator">=</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> uri<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>comUrl<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  uri <span class="token operator">=</span> <span class="token string">&#39;http://localhost:&#39;</span> <span class="token operator">+</span> port<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> tempUrl <span class="token operator">=</span> comUrl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  uri <span class="token operator">=</span> <span class="token string">&#39;http://localhost:&#39;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tempUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">devMiddleware<span class="token punctuation">.</span><span class="token function">waitUntilValid</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;&gt; Listening at &#39;</span> <span class="token operator">+</span> uri <span class="token operator">+</span> <span class="token string">&#39;\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// when env is testing, don&#39;t need open it</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>autoOpenBrowser <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;testing&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">opn</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始打开&quot;</span> <span class="token operator">+</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-34Y0emjC.js" defer></script>
  </body>
</html>
