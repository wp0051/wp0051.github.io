import{_ as o,c,e as p,a as s,d as a,b as t,w as l,r as i,o as u}from"./app-D6TqyvMs.js";const r={};function k(d,n){const e=i("RouteLink");return u(),c("div",null,[n[12]||(n[12]=p(`<h1 id="node-build-dev-server-js" tabindex="-1"><a class="header-anchor" href="#node-build-dev-server-js"><span>node build/dev-server.js</span></a></h1><h2 id="检查各执行脚本的版本" tabindex="-1"><a class="header-anchor" href="#检查各执行脚本的版本"><span>检查各执行脚本的版本</span></a></h2><ul><li>检查当前环境下各个脚本版本是否符合package.json下执行的版本规则</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./check-versions&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// check-versions</span></span>
<span class="line"><span class="token keyword">var</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span>   <span class="token comment">// 终端输出颜色化</span></span>
<span class="line"><span class="token keyword">var</span> semver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;semver&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 语义化版本号处理</span></span>
<span class="line"><span class="token keyword">var</span> packageConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../package.json&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">exec</span> <span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;child_process&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 创建一个子进程，同步执行传入的命令（cmd），转化字符串，去除空格</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> versionRequirements <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;node&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">currentVersion</span><span class="token operator">:</span> semver<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// clean方法不是清空，是将获取到的node版本号 v11.15.0语义化11.15.0</span></span>
<span class="line">    <span class="token literal-property property">versionRequirement</span><span class="token operator">:</span> packageConfig<span class="token punctuation">.</span>engines<span class="token punctuation">.</span>node  <span class="token comment">// 从package.json读取node的版本要求(engines.node)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;npm&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">currentVersion</span><span class="token operator">:</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&#39;npm --version&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 输出直接就是6.7.0</span></span>
<span class="line">    <span class="token literal-property property">versionRequirement</span><span class="token operator">:</span> packageConfig<span class="token punctuation">.</span>engines<span class="token punctuation">.</span>npm</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> warnings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> versionRequirements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> mod <span class="token operator">=</span> versionRequirements<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">    <span class="token comment">// 使用 semver.satisfies 检查版本是否满足要求</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>semver<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>currentVersion<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>versionRequirement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 如果当前进程的node/npm不符合package.json的要求，添加警告</span></span>
<span class="line">      warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&#39;: &#39;</span> <span class="token operator">+</span></span>
<span class="line">        chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>currentVersion<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39; should be &#39;</span> <span class="token operator">+</span>  </span>
<span class="line">        chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>versionRequirement<span class="token punctuation">)</span>  <span class="token comment">// 美化终端输出 比如这段输出为    node：6.6.6(这个版本号是红色的子) shoule be &gt; 10.8.8(这个版本号是绿色的)</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>warnings<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">&#39;To use this template, you must update following to modules:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> warnings<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">var</span> warning <span class="token operator">=</span> warnings<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;  &#39;</span> <span class="token operator">+</span> warning<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">// 退出进程，返回错误码 1,非0都是错误码，这个就属于错误退出进程，命令终止，不往下执行了，输出错误信息；如果是0，那就是成功的退出码，正常退出，继续执行后面的指令</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取当前环境变量env" tabindex="-1"><a class="header-anchor" href="#获取当前环境变量env"><span>获取当前环境变量ENV</span></a></h2><ul><li>获取当前进程环境变量NODE_ENV的值，没有默认读取dev的环境变量</li><li><em><strong>我最初有执行cross-env NODE_ENV=development，为什么获取不到呢</strong></em><ul><li>因为这段命令之后直接&amp;&amp;连接下一个命令，所以上面这个命令只是做了 <strong>设置环境变量NODE_ENV，然后退出进程，删除环境变量</strong></li><li>命令除了消耗一点CPU时间外，没有任何实际作用。</li><li>正确写法是<strong>cross-env NODE_ENV=development node dev-server.js</strong></li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../config&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>  <span class="token comment">// 当前代码是JSON.parse(config.dev.env.NODE_ENV)这是因为dev里面声明env: &#39;&quot;development&quot;&#39;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取开发环境的webpack配置" tabindex="-1"><a class="header-anchor" href="#获取开发环境的webpack配置"><span>获取开发环境的webpack配置</span></a></h2>`,8)),s("ul",null,[s("li",null,[n[1]||(n[1]=a("查看",-1)),t(e,{to:"/mds/buildTools/webpack-dev-conf.html"},{default:l(()=>[...n[0]||(n[0]=[a("webpack.dev.conf",-1)])]),_:1}),n[2]||(n[2]=a("配置解读",-1))]),n[3]||(n[3]=s("li",null,"process.env.PORT可以通过 PORT=6666 npm run dev --account 设置",-1)),n[4]||(n[4]=s("li",null,"autoOpenBrowser 是否自动打开浏览器 !! --> 转换为 Boolean值",-1))]),n[13]||(n[13]=p(`<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> webpackConfig <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span></span>
<span class="line">  <span class="token operator">?</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.prod.conf&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack.dev.conf&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>port<span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">var</span> autoOpenBrowser <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>autoOpenBrowser</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="引入服务器框架express-webpack" tabindex="-1"><a class="header-anchor" href="#引入服务器框架express-webpack"><span>引入服务器框架express，webpack</span></a></h2><h3 id="创建实例" tabindex="-1"><a class="header-anchor" href="#创建实例"><span>创建实例</span></a></h3><ul><li>创建Express服务器实例，初始化一个 Web 服务器，用于处理 HTTP 请求，后续可以添加路由、中间件等。</li><li>创建Webpack实例，但是尚未执行打包，根据webpack.prod.conf或者webpack.dev.conf创建compiler编译器</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="构建启动服务" tabindex="-1"><a class="header-anchor" href="#构建启动服务"><span>构建启动服务</span></a></h3><ul><li>我们实际打包查看发现：执行npm run dev后，webpackConfig.output.publicPath下没有打包文件夹，并且从终端输出来看执行完gulp之后，等了几秒，终端输出&quot;开始打开&quot; + uri，打开默认浏览器打开了&#39;http://localhost:&#39; + port + <code>/\${tempUrl}/index.html</code>;页面一直加载也没有失败404，过了一会儿终端输出Compiled successfully in 20975ms 以及Listening at http://localhost:8085/account/index.html, 下面来解释这个过程，并且查看构建和启动服务流程。</li></ul><h4 id="开始构建" tabindex="-1"><a class="header-anchor" href="#开始构建"><span>开始构建</span></a></h4><ul><li>require(&#39;webpack-dev-middleware&#39;)：接收构建器，启动 webpack 的 watch 模式（文件监控和编译），将打包输出存到内存中（没存到硬盘，肉眼看不到）</li><li>这个构建过程是异步操作，所以先执行后面的操作，而浏览器请求一直没失败是因为执行了HTTP请求挂起，不立即响应，挂起请求</li><li>浏览器还无法访问编译结果,HTTP 请求无法被处理, 编译结果&quot;困在&quot;内存中，没有对外接口</li><li>require(&#39;webpack-hot-middleware&#39;)启用热模块替换（HMR），建立 WebSocket 连接，实现浏览器与服务器实时通信，<em><strong>在webpack入口文件依赖的代码变更时</strong></em> 发送给浏览器，但是浏览器这个时候不会更新，还需要依赖热更新插件代码执行模块更新</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> webpackConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>  <span class="token comment">// 设置输出路径</span></span>
<span class="line">  <span class="token literal-property property">quiet</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 减少日志</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> hotMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-hot-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">┌─────────────────┐    ┌──────────────────┐    ┌────────────────┐</span>
<span class="line">│   浏览器         │    │   Express服务器  │    │   内存文件系统  │</span>
<span class="line">│                 │    │                  │    │                │</span>
<span class="line">│ 请求 main.js ───┼─—-─→│ devMiddleware   |───→│ /dist/main.js  │</span>
<span class="line">│                 │    │                  │    │                │</span>
<span class="line">│ 收到JS文件 ←─────┼────│ 返回内存内容 ←────┼────│ 内存中的代码    │</span>
<span class="line">└─────────────────┘    └──────────────────┘    └────────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="添加页面重载事件钩子" tabindex="-1"><a class="header-anchor" href="#添加页面重载事件钩子"><span>添加页面重载事件钩子</span></a></h4>`,12)),s("ul",null,[n[8]||(n[8]=s("li",null,"监听了 webpack 编译器的 'compilation' 事件，该事件在每次创建新的编译时触发",-1)),n[9]||(n[9]=s("li",null,"在编译过程中，又监听了 'html-webpack-plugin-after-emit' 事件，这个事件是由 html-webpack-plugin 在生成 HTML 文件并发出到输出目录后触发的。",-1)),s("li",null,[n[6]||(n[6]=a("当 html-webpack-plugin 处理的 HTML 模板(在",-1)),t(e,{to:"/mds/buildTools/webpack-dev-conf.html"},{default:l(()=>[...n[5]||(n[5]=[a("webpack.dev.conf",-1)])]),_:1}),n[7]||(n[7]=a("查看)发生变化时，通过热重载中间件发送一个重载信号，强制页面重新加载（因为热更新可能无法直接更新 HTML 文件， 因为webpack针对的是js入口）",-1))]),n[10]||(n[10]=s("li",null,"其实这段代码是有害的，因为有热更新员（webpack-hot-middleware，实现浏览器与服务器实时通信 ）加webpack热加载插件（HotModuleReplacementPlugin），打包插入更新脚本，接收更新员通知的更新，执行更新，而下方代码代码更新，直接重载，破坏了上面的组合",-1)),n[11]||(n[11]=s("li",null,[a("什么情况需要呢？？场景1：HTML模板结构发生重大变化"),s("code",null,'<div id="app"></div> -> <div id="root"></div>'),a(";手动管理缓存的极端情况")],-1))]),n[14]||(n[14]=p(`<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// force page reload when html-webpack-plugin template changes</span></span>
<span class="line">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;compilation&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  compilation<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;html-webpack-plugin-after-emit&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    hotMiddleware<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">&#39;reload&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="解决前端路径资源404问题" tabindex="-1"><a class="header-anchor" href="#解决前端路径资源404问题"><span>解决前端路径资源404问题</span></a></h4><ul><li>浏览器请求: http://localhost:8085/user/profile</li><li>服务器检查: 没有 /user/profile 这个文件</li><li>history-api-fallback 介入</li><li>返回: 入口页面</li><li>浏览器收到入口文件，前端路由接管显示 /user/profile 页面</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// handle fallback for HTML5 history API</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;connect-history-api-fallback&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="建立浏览器服务器热更新通信" tabindex="-1"><a class="header-anchor" href="#建立浏览器服务器热更新通信"><span>建立浏览器服务器热更新通信</span></a></h4><ul><li>将内存中的编译结果暴露为 HTTP 服务,处理静态资源请求,建立浏览器与编译结果的桥梁</li><li>建立浏览器与服务器的双向通信通道，让热更新有效</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token comment">// serve webpack bundle output</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>devMiddleware<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// enable hot-reload and state-preserving</span></span>
<span class="line"><span class="token comment">// compilation error display</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>hotMiddleware<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="暴露可访问静态资源目录" tabindex="-1"><a class="header-anchor" href="#暴露可访问静态资源目录"><span>暴露可访问静态资源目录</span></a></h4><ul><li>在入口文件查找下的图片资源会经过打包到webpack的output下，这个资源devMiddleware可以提供访问，但是一些静态资源（如果css未在入口文件为源头查找发现使用，那脱离devMiddleware内存存储的静态资源更多），需要开发静态资源的访问权限（现在开发服务器根路径在output输出文件夹）；</li><li>path.posix.join(): 使用 POSIX 风格的路径拼接（兼容 Unix/Linux 和 Windows）</li><li>然后废弃上面的设置，直接设置为根目录</li><li>express.static(&#39;static&#39;): 创建指向 static 目录的静态文件服务</li><li>app.use(&#39;/&#39;, ...): 将这个服务挂载到根路径</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// serve pure static assets</span></span>
<span class="line"><span class="token keyword">var</span> staticPath <span class="token operator">=</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>assetsPublicPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>assetsSubDirectory<span class="token punctuation">)</span></span>
<span class="line">staticPath <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>staticPath<span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="开启端口监听自定打开浏览器" tabindex="-1"><a class="header-anchor" href="#开启端口监听自定打开浏览器"><span>开启端口监听自定打开浏览器</span></a></h4><ul><li>getCommand获取命令参数，打包模块名</li><li>编译结束之后输出信息</li><li>app.listen 监听指定端口，打开（opn）模块index页面</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> opn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;opn&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> comUrl <span class="token operator">=</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> uri<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>comUrl<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  uri <span class="token operator">=</span> <span class="token string">&#39;http://localhost:&#39;</span> <span class="token operator">+</span> port<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> tempUrl <span class="token operator">=</span> comUrl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  uri <span class="token operator">=</span> <span class="token string">&#39;http://localhost:&#39;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tempUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">devMiddleware<span class="token punctuation">.</span><span class="token function">waitUntilValid</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;&gt; Listening at &#39;</span> <span class="token operator">+</span> uri <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// when env is testing, don&#39;t need open it</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>autoOpenBrowser <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;testing&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">opn</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始打开&quot;</span> <span class="token operator">+</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13))])}const m=o(r,[["render",k]]),b=JSON.parse('{"path":"/mds/buildTools/webpack.html","title":"node build/dev-server.js","lang":"en-US","frontmatter":{},"git":{},"filePathRelative":"mds/buildTools/webpack.md"}');export{m as comp,b as data};
